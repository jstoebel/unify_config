---
# - name: Ensure backup gem is installed
#   command: 'bash -lc "gem install backup"'
#   become: no

# copy backup config file
- name: Create backup file structure
  file:
    path: "{{item}}"
    owner: "{{user_name}}"
    group: www-data
    mode: 0700
    recurse: yes
    state: directory
  with_items:
    - "/home/{{user_name}}/Backup"
    - "/home/{{user_name}}/Backup/models"

- name: Move config and model
  template:
    src: templates/{{item}}.rb.j2
    dest: "/home/{{user_name}}/{{item}}.rb"
    owner: "{{user_name}}"
    group: www-data
    mode: 0700
  with_items:
    - "Backup/config"
    - "Backup/models/unify"

- name: Check backup config
  command: 'bash -lc "backup check"'
  become: no

- name: Perform first backup
  command: 'bash -lc "backup perform --trigger unify --config-file /home/{{user_name}}/Backup/config.rb"'
  become: no
# set cron job
